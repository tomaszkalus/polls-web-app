{% extends "layout.html" %}
{% block page_title %}
{{ poll.name }} - Results
{% endblock %}
{% block content %}

{% import 'macros/delete_poll_modal.html' as modal %}
{% import 'macros/edit_poll_modal.html' as edit_modal %}
{% import 'macros/poll_header.html' as header %}

{{ header.render_poll_header(poll) }}

<div class="mb-2">
    <span><i class="fas fa-poll"></i> {{ poll.total_number_of_votes }} votes</span>
    {% if poll.is_unlisted %}
    <span><i class="fas fa-unlock ms-2"></i> Unlisted</span>
    {% else %}
    <span><i class="fas fa-eye ms-2"></i> Public</span>
    {% endif %}
    {% if poll.author == current_user %}
    <!-- <a class="ms-2" href=""><i class="fas fa-edit me-0"></i>Edit poll</a> -->

    <button type="button" class="ms-2 pt-0 px-0 btn btn-link" data-bs-toggle="modal" data-bs-target="#edit-poll-modal"><i
            class="fas fa-edit me-1"></i>Edit poll</button>

    <button type="button" class="ms-2 pt-0 px-0 btn btn-link text-danger" data-bs-toggle="modal"
        data-bs-target="#delete-poll-modal"><i class="fas fa-trash me-1"></i>Delete poll</button>


    {% endif %}
</div>

<div class="mb-4">
    {% for answer in poll.answers %}
    <p class="mb-2" id="answer-{{ loop.index }}">{{ answer.text }} - {{ answer.answer_percent }}%
        ({{answer.number_of_votes }} votes)</p>
    <div class="progress mb-3" role="progressbar" style="height:20px">
        <div class="progress-bar" style="width: {{answer.answer_percent}}%">{{answer.answer_percent}}%</div>
    </div>
    {% endfor %}
</div>

<div class="mt-3">
    {% if current_user.is_anonymous %}
    <p class="fst-italic"><a href="{{url_for("auth.login")}}">Log in</a> to vote in this poll.</p>
    {% elif current_user.did_vote(poll) %}
    <p class="fst-italic">You've already voted in this poll</p>
    {% else %}
    <a href="{{url_for("polls.poll_vote", poll_id=poll.id)}}" class="btn btn-primary px-5 mb-4">Vote</a>
    {% endif %}
</div>

<div class="mt-5 d-flex justify-content-center">
    <div class="w-50">
        <canvas id="poll-results"></canvas>
    </div>
</div>

{{ modal.render_delete_modal(poll) }}
{{ edit_modal.render_edit_modal(poll) }}


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>


    (() => {
        const poll_delete_btn = document.querySelector('#poll-delete-btn');
    poll_delete_btn.addEventListener('click', () => {
        const poll_id = poll_delete_btn.dataset.pollId;
        const poll_name = poll_delete_btn.dataset.pollName;
        const delete_url = `/delete_poll/${poll_id}`;
        console.log(poll_id)


        fetch(delete_url, {
            method: "POST",
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        })
    })
    })();

    

    const poll_results = {{ poll_answers | tojson }};

    const pollAnswers = poll_results.map(subList => subList[0]);
    const pollVotes = poll_results.map(subList => subList[1]);
    const pollPercentages = poll_results.map(subList => subList[2]);

    const ctx = document.getElementById('poll-results');

    const chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: pollAnswers,
            datasets: [{
                label: '# of Votes',
                data: pollVotes,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const chart_colors = chart.data.datasets[0].backgroundColor
    const progressBars = document.querySelectorAll('.progress-bar');
    for (let i = 0; i < progressBars.length; i++) {
        progressBars[i].style.backgroundColor = chart_colors[i];
    }

</script>




{% endblock %}