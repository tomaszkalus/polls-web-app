{% extends "layout.html" %}
{% block page_title %}
Poll - {{ poll.name }}
{% endblock %}
{% block content %}

<div class="mb-2">
    <p class="fs-5 mb-0 text-secondary">Poll</p>
    <p class="fw-bold fs-2 mb-0">{{ poll.name }}</p>
</div>

<div class="mb-2">
    <span><i class="fas fa-poll"></i> {{ poll.total_number_of_votes }} votes</span>
    {% if poll.is_unlisted %}
    <span><i class="fas fa-unlock ms-2"></i> Unlisted</span>
    {% else %}
    <span><i class="fas fa-eye ms-2"></i> Public</span>
    {% endif %}
</div>

<div class="mt-3">
    {% if current_user.is_anonymous %}
    <p class="fst-italic"><a href="{{url_for("auth.login")}}">Log in</a> to vote in this poll.</p>
    {% elif current_user.did_vote(poll) %}
    <p class="fst-italic">You've already voted in this poll</p>
    {% else %}
    <a href="{{url_for("polls.poll_vote", poll_id=poll.id)}}" class="btn btn-primary px-5 mb-4">Vote</a>
    {% endif %}
</div>

<div class="mb-5">
    {% for answer in poll.answers %}
    <p class="mb-2" id="answer-{{ loop.index }}">{{ answer.text }} - {{ answer.answer_percent }}%
        ({{answer.number_of_votes }} votes)</p>
    <div class="progress mb-3" role="progressbar" style="height:20px">
        <div class="progress-bar" style="width: {{answer.answer_percent}}%">{{answer.answer_percent}}%</div>
    </div>
    {% endfor %}
</div>

<div class="mt-5 d-flex justify-content-center">
    <div class="w-50">
        <canvas id="poll-results"></canvas>
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- <script type="module" src="{{url_for('static', filename='pollBarChartPreview.js')}}"></script> -->
<script>

    const poll_results = {{ poll_answers | tojson }};

    const pollAnswers = poll_results.map(subList => subList[0]);
    const pollVotes = poll_results.map(subList => subList[1]);
    const pollPercentages = poll_results.map(subList => subList[2]);

    const ctx = document.getElementById('poll-results');

    const chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: pollAnswers,
            datasets: [{
                label: '# of Votes',
                data: pollVotes,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const chart_colors = chart.data.datasets[0].backgroundColor
    const progressBars = document.querySelectorAll('.progress-bar');
    for (let i = 0; i < progressBars.length; i++) {
        progressBars[i].style.backgroundColor = chart_colors[i];
    }

</script>




{% endblock %}